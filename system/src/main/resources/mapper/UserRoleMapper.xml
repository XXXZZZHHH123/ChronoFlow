<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="nus.edu.u.system.mapper.user.UserRoleMapper">

    <select id="selectAliveRoleIdsByUser" resultType="java.lang.Long">
        SELECT role_id
        FROM sys_user_role
        WHERE user_id = #{userId}
          AND deleted = 0
    </select>

    <update id="batchLogicalDelete">
        UPDATE sys_user_role
        SET deleted = 1,
        update_time = NOW(),
        updater = #{operator}
        WHERE user_id = #{userId}
        AND deleted = 0
        AND role_id IN
        <foreach collection="roleIds" item="rid" open="(" separator="," close=")">
            #{rid}
        </foreach>
    </update>

    <update id="batchRevive">
        UPDATE sys_user_role
        SET deleted = 0,
        update_time = NOW(),
        updater = #{operator}
        WHERE user_id = #{userId}
        AND deleted = 1
        AND role_id IN
        <foreach collection="roleIds" item="rid" open="(" separator="," close=")">
            #{rid}
        </foreach>
    </update>

    <!-- Batch Upsert: Explicitly write id/user_id/role_id/tenant_id/creator/updater -->
    <insert id="batchUpsertUserRoles">
        INSERT INTO sys_user_role
        (id, user_id, role_id, tenant_id, creator, create_time, updater, update_time, deleted)
        VALUES
        <foreach collection="records" item="r" separator=",">
            (#{r.id}, #{r.userId}, #{r.roleId}, #{r.tenantId},
            #{r.creator}, NOW(), #{r.updater}, NOW(), 0)
        </foreach>
        ON DUPLICATE KEY UPDATE
        deleted = 0,
        update_time = NOW(),
        updater = VALUES(updater)
    </insert>

</mapper>